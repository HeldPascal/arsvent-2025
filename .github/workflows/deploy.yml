name: Deploy to VPS

on:
  workflow_run:
    workflows:
      - Build and Check
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'workflow_dispatch'
    env:
      DEPLOY_SCRIPT: ${{ vars.DEPLOY_SCRIPT }}
      DEPLOY_ENV_FILE: ${{ vars.DEPLOY_ENV_FILE }}
      DEPLOY_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Run deployment on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT }}
          script: |
            echo "[deploy] Deploying SHA: ${DEPLOY_SHA}"
            "${DEPLOY_SCRIPT}" "${DEPLOY_ENV_FILE}" "${DEPLOY_SHA}"
